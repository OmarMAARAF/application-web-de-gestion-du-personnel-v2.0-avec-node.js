<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Responsive Admin Dashboard Template">
        <meta name="keywords" content="admin,dashboard">
        <meta name="author" content="stacks">
        <!-- The above 6 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        
        <!-- Title -->
        <title>Liste Des demandes</title>

        <!-- Styles -->
        <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,700,800&display=swap" rel="stylesheet">
        <link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="../../assets/plugins/font-awesome/css/all.min.css" rel="stylesheet">
        <link href="../../assets/plugins/perfectscroll/perfect-scrollbar.css" rel="stylesheet">

      
        <!-- Theme Styles -->
        <link href="../../assets/css/main.min.css" rel="stylesheet">
        <link href="../../assets/css/dark-theme.css" rel="stylesheet">
        <link href="../../assets/css/custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
      <div class='loader'>
        <div class='spinner-grow text-primary' role='status'>
          <span class='sr-only'>Loading...</span>
        </div>
      </div>

        <div class="page-container">
          <div class="page-header">
            <nav class="navbar navbar-expand-lg d-flex justify-content-between">
              <div class="" id="navbarNav">
                <ul class="navbar-nav" id="leftNav">
                  <li class="nav-item">
                    <a class="nav-link" id="sidebar-toggle" href="#"><i data-feather="arrow-left"></i></a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Settings</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Help</a>
                  </li>
                </ul>
                </div>
                <div class="logo">
                  <a class="navbar-brand" href="index.html"></a>
                </div>
                <div class="" id="headerNav">
                  <ul class="navbar-nav" id="Mynav">
                    <li class="nav-item dropdown">
                      <a class="nav-link search-dropdown" href="#" id="searchDropDown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i data-feather="search"></i></a>
                      <div class="dropdown-menu dropdown-menu-end dropdown-lg search-drop-menu" aria-labelledby="searchDropDown">
                        <form>
                          <input class="form-control" type="text" placeholder="Type something.." aria-label="Search">
                        </form>
                        <h6 class="dropdown-header">Recent Searches</h6>
                        <a class="dropdown-item" href="#">charts</a>
                        <a class="dropdown-item" href="#">new orders</a>
                        <a class="dropdown-item" href="#">file manager</a>
                        <a class="dropdown-item" href="#">new users</a>
                      </div>
                    </li>
                    
                    <li class="nav-item dropdown" id="befor">
                      <a class="nav-link profile-dropdown" href="#" id="profileDropDown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><img src="../../assets/images/avatars/profile-image.png" alt=""></a>
                      <div class="dropdown-menu dropdown-menu-end profile-drop-menu" aria-labelledby="profileDropDown">
                        <a class="dropdown-item" href="#"><i data-feather="user"></i>Profile</a>
                        <a class="dropdown-item" href="#"><i data-feather="inbox"></i>Messages</a>
                        <a class="dropdown-item" href="#"><i data-feather="edit"></i>Activities<span class="badge rounded-pill bg-success">12</span></a>
                        <a class="dropdown-item" href="#"><i data-feather="check-circle"></i>Tasks</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#"><i data-feather="settings"></i>Settings</a>
                        <a class="dropdown-item" href="#"><i data-feather="unlock"></i>Lock</a>
                        <a class="dropdown-item" href="#"><i data-feather="log-out"></i>Logout</a>
                      </div>
                    </li>
                  </ul>
              </div>
            </nav>
        </div>
        <div class="page-sidebar">
                <ul class="list-unstyled accordion-menu">
                  <li class="sidebar-title">
                    Main
                  </li>
                  <li>
                    <a href="index.html"><i data-feather="home"></i>Dashboard</a>
                  </li>
                  <li >
                    <a href="adduser.html"><i data-feather="plus-circle"></i>Add user</a>
                  </li>
                  <li class="active-page">
                    <a href="liste_demande.html"><i data-feather="edit"></i>Demandes</a>
                  </li>
                </ul>
            </div>
            <div class="page-content">
                <div class="main-wrapper">
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-8">
                                            <h2>Liste Des Demandes</h2>
                                        </div>
                                    </div>
                                  
                                    <div class="row">
                                      <div class="table-responsive">
                                        <table class="table invoice-table">
                                            <thead>
                                              <tr>
                                                <th scope="col">Cin</th>
                                                <th scope="col">Date de prise</th>
                                                <th scope="col">Nombre de jours</th>
                                                <th scope="col">Date de depart</th>
                                                <th scope="col">Etat</th>
                                                
                                                <th>Action</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                             
                                              
                                            </tbody>
                                          </table>
                                          </div>
                                    </div>
                                    
                            </div>
                        </div>
                    </div>
                </div>
                                  
                </div>
              
            </div>
        
        <!-- Javascripts -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="../../assets/js/notification.js"></script>
        <script>
          function display(res){
            const tbody = document.querySelector('table');
            tbody.textContent=""
            const e =document.createElement('tbody')
            demandes = res.data.demande
            let table=``
            let i=0
            const disp = demandes.forEach((Element)=>{
              table += `
              <tr><th scope="row">${Element.cin} </th>
                                                  <td>${Element.prise.substring(0,24)}</td>
                                                  <td>${Element.nb_jour}</td>
                                                  <td>${Element.date_depart}</td>`
                                                  if(Element.etat === "En attente"){
              table +=`
              <td><span class="badge bg-warning">${Element.etat}</span></td>
              <td>
                                                  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModalCenter${i}">
                                                    Validée
                                                  </button>
                                                  <div class="modal fade" id="exampleModalCenter${i}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                      <div class="modal-content">
                                                        <div class="modal-header">
                                                          <h5 class="modal-title" id="exampleModalCenterTitle">Validée La Demande</h5>
                                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                        êtes-vous sûr de vouloir valider cette Demande
                                                        </div>
                                                        <div class="modal-footer">
                                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermée</button>
                                                          <a href="./getdemande.html?action=valide&id=${Element._id}">  <button type="button" class="btn btn-success" id="valide" data="${Element._id}">Validée</button> </a>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>

                                                  <div class="modal fade" id="exampleModalCenter2${i}" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                      <div class="modal-content">
                                                        <div class="modal-header">
                                                          <h5 class="modal-title" id="exampleModalCenterTitle">Refusée La Demade</h5>
                                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                        êtes-vous sûr de vouloir refuser cette Demande
                                                        </div>
                                                        <div class="modal-footer">
                                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermée</button>
                                                          <a href="./getdemande.html?action=refus&id=${Element._id}">  <button type="button" class="btn btn-danger" style="background-color: #fc7878;">Refusée</button> </a>

                                                          </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalCenter2${i}" style="background-color: #fc7878;">
                                                    Refusée
                                                  </button>


                                                    
                                                   
                                                  </td>
                                                  </tr>
              `
              i++
                                                }
              else if(Element.etat === "valide"){
                table +=`<td><span class="badge bg-success">Validée</span></td>
                                                  <td>
                                                  
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalCenter2${i}" style="background-color: #fc7878;" >
                                                  Refusée
                                                </button>

                                                <div class="modal fade" id="exampleModalCenter2${i}" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered">
                                                  <div class="modal-content">
                                                    <div class="modal-header">
                                                      <h5 class="modal-title" id="exampleModalCenterTitle">Refusée La Demade</h5>
                                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                    êtes-vous sûr de vouloir refuser cette Demande
                                                    </div>
                                                    <div class="modal-footer">
                                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermée</button>
                                                      <a href="./getdemande.html?action=refus&id=${Element._id}">  <button type="button" class="btn btn-danger" style="background-color: #fc7878;">Refusée</button> </a>

                                                      </div>
                                                  </div>
                                                </div>
                                              </div>

                                                <a href="../Doc/text.txt" download="my_file.txt">
                                                <button type="button" class="btn btn-primary">
                                                  Extraire
                                                </button>
                                                </a>
                                                

                                                  </td>
                                                  
                                                </tr>`
                                                i++
              }
              else if (Element.etat === 'refus'){
                
                table +=`<td><span class="badge bg-danger" style="background-color: #fc7878;">Refusée</span></td>
                                                  <td>
                                                  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModalCenter${i}" >
                                                  Validée
                                                  </button>
                                                  <div class="modal fade" id="exampleModalCenter${i}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                      <div class="modal-content">
                                                        <div class="modal-header">
                                                          <h5 class="modal-title" id="exampleModalCenterTitle">Validée La Demande </h5>
                                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                        êtes-vous sûr de vouloir valider cette Demande
                                                        </div>
                                                        <div class="modal-footer">
                                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermée</button>
                                                          <a href="./getdemande.html?action=valide&id=${Element._id}">  <button type="button" class="btn btn-success" id="valide" data="${Element._id}">Validée</button> </a>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                    </td>
                                                    
                                                  </tr>`
                i++
              }
              
            })
            e.innerHTML= table
            tbody.appendChild(e);
           
        }
        

          axios.get('./api/getdemande').then((res)=>display(res))
          getNotification()

          
          // Create WebSocket connection.
              const socket = new WebSocket('ws://localhost:3000');

              // Connection opened
              socket.addEventListener('open', function (event) {
                  console.log('Connected to WS Server')
              });
              // Listen for messages
              socket.addEventListener('message', function (event) {
                getNotification()
                axios.get('./api/getdemande').then((res)=>display(res))
                console.log("new demande")
                
              });


    
          
        </script>
        <script src="../../assets/plugins/jquery/jquery-3.4.1.min.js"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/feather-icons"></script>
        <script src="../../assets/plugins/perfectscroll/perfect-scrollbar.min.js"></script>
        <script src="../../assets/js/main.min.js"></script>
    </body>
</html>